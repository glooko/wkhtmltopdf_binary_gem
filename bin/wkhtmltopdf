#!/usr/bin/env ruby

###
# wkhtmltopdf_binary_gem Copyright 2013 The University of Iowa
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy
# of the License at http://www.apache.org/licenses/LICENSE-2.0

require 'rbconfig'
require 'securerandom'
require 'fileutils'

suffix =
  case RbConfig::CONFIG['host_os']
  when /linux/
    RbConfig::CONFIG['host_cpu'] == 'x86_64' ? 'linux_amd64' : 'linux_x86'
  when /darwin/
    'darwin_x86'
  else
    raise 'Invalid platform. Must be running on linux or intel-based Mac OS.'
  end

binary = "#{__FILE__}_#{suffix}"

raise 'chromium binary not found.' unless system('which chromium')

uuid = SecureRandom.uuid
# ENV['PWD'] is path to kings-landing
temp_path = "#{ENV['PWD']}/tmp/pdf"
# create ENV['PWD']/tmp/pdf if it doesn't exist
FileUtils.mkdir_p temp_path

html_path = "#{temp_path}/html_#{uuid}.html"
File.open(html_path, 'wb') do |f|
  f.write "\uFEFF"
  f.write STDIN.read
end

output_path = "#{temp_path}/output_#{uuid}.html"
success = system "chromium --headless --disable-gpu --dump-dom #{html_path} > #{output_path}"
raise "chromium failed to generate html with '#{uuid}' uuid." unless success

cmd = $*.unshift(binary)
cmd[-2] = output_path

system *cmd
raise "wkhtmltopdf binary failed to generate pdf from #{output_path}." unless success

# clean up temporary files
File.delete html_path if File.exist? html_path
File.delete output_path if File.exist? output_path
